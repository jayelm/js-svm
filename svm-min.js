var textInput=document.getElementById("text");var ramInput=document.getElementById("ram");var initialPcInput=document.getElementById("initialpc");var recLimInput=document.getElementById("recursionlimit");var pcText=document.getElementById("PC");var pswText=document.getElementById("PSW");var r0Text=document.getElementById("R0");var r1Text=document.getElementById("R1");var r2Text=document.getElementById("R2");var r3Text=document.getElementById("R3");var errorText=document.getElementById("error");if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}function runSVM(){errorText.innerHTML="";var r=textInput.value.trim();var e=ramInput.value.trim();var t=initialPcInput.value.trim();var a=recLimInput.value.trim();if(r.length===0)printError("Text is empty");if(e.length===0)printError("RAM is empty");if(t.length===0)printError("Initial PC is empty");if(a.length===0)printError("recLim is empty");if(isNaN(t))printError("Initial PC "+t+" is not a number");if(isNaN(a))printError("Recursion limit "+a+" is not a number");t=parseInt(t);a=parseInt(a);r=r.replace(/\(\*.*\*\)/g,"");r=r.split("\n");var n=[];var i=[];if(e.charAt(0)==="["){if(e.charAt(e.length-1)!=="]")printError("Mismatched brackets: "+e);e=e.substring(1,e.length-1)}e=e.split(";");if(e.length===0)printError("RAM parse error");for(var s=0;s<e.length;s++){i.push(parseInt(e[s]))}for(var s=0;s<r.length;s++){n.push(parseInstruction(r[s]))}var c=new Image(i,n);console.log(c);svm(c,t,a)}function parseInstruction(r){r=r.trim();if(r.charAt(r.length-1)===";")r=r.substring(0,r.length-1);var e=r.substring(0,3);switch(e){case"Lod":case"Sto":case"Mov":case"Add":case"Sub":case"Cmp":var t=r.match(/{(.*)}/);if(t.length!==2)printError("Parse error for "+r);var a={};t=t[1].split(";");for(var n=0;n<t.length;n++){var i=t[n].split("=");var s=i[0].trim();var c=i[1].trim();if(!isNaN(c))c=parseInt(c);a[s]=c}return new Instruction(e,a);case"Blt":case"Beq":case"Bgt":case"Jmp":var l=r.substring(3);var v=l.trim();if(v.charAt(0)==="("){if(v.charAt(v.length-1)!==")")printError("Mismatched parentheses: "+r);v=v.substring(1,v.length-1)}if(isNaN(v))printError("Int expected for "+r);v=parseInt(v);var a={};a.displacement=v;return new Instruction(e,a);case"Cpz":var l=r.substring(3);var u=l.trim();if(!(u==="R0"||u==="R1"||u==="R2"||u==="R3"))printError("Register expected for "+r);var a={};a.r=u;return new Instruction(e,a);case"Hlt":return new Instruction(e,{});default:printError("Unknown instruction "+e)}}function printError(r){errorText.innerHTML+=r+"\n";throw r}function printState(r,e,t){pcText.value=r;pswText.value=e;r0Text.value=t.r0;r1Text.value=t.r1;r2Text.value=t.r2;r3Text.value=t.r3}function Instruction(r,e){this.type=r;this.vals=e}function Registers(r,e,t,a){this.r0=r;this.r1=e;this.r2=t;this.r3=a}function Image(r,e){this.data=r;this.text=e}function registerGet(r,e){switch(r){case"R0":return e.r0;case"R1":return e.r1;case"R2":return e.r2;case"R3":return e.r3;default:printError("Unknown register "+r)}}function registerPut(r,e,t){switch(e){case"R0":return new Registers(r,t.r1,t.r2,t.r3);case"R1":return new Registers(t.r0,r,t.r2,t.r3);case"R2":return new Registers(t.r0,t.r1,r,t.r3);case"R3":return new Registers(t.r0,t.r1,t.r2,r);default:printError("Unknown register "+e)}}function ramGet(r,e){return e[r]}function ramPut(r,e,t){var a=t.slice();a.splice(e,0,r);return a}function cycle(r,e,t,a,n,i){if(n>i)printError("Recursion limit "+i+" exceeded");var s=a.text;var c=a.data;var l=ramGet(r,s);var v=r+1;printState(r,e,t);switch(l.type){case"Lod":var u=l.vals.rd;var o=l.vals.addr;var p=ramGet(o,c);var m=registerPut(p,u,t);cycle(v,e,m,a,n+1,i);break;case"Sto":var g=l.vals.rs;var o=l.vals.addr;var p=registerGet(g,t);var d=ramPut(p,o,c);cycle(v,e,t,new Image(d,s),n+1,i);break;case"Mov":var u=l.vals.rd;var g=l.vals.rs;var f=registerGet(g,t);var m=registerPut(f,u,t);cycle(v,e,m,a,n+1,i);break;case"Add":var u=l.vals.rd;var g=l.vals.rs;var h=l.vals.rt;var I=registerGet(g,t);var y=registerGet(h,t);var m=registerPut(I+y,u,t);cycle(v,e,m,a,n+1,i);break;case"Sub":var u=l.vals.rd;var g=l.vals.rs;var h=l.vals.rt;var I=registerGet(g,t);var y=registerGet(h,t);var m=registerPut(I-y,u,t);cycle(v,e,m,a,n+1,i);break;case"Cmp":var g=l.vals.rs;var h=l.vals.rt;var I=registerGet(g,t);var y=registerGet(h,t);var p=I-y;cycle(v,p,t,a,n+1,i);break;case"Cpz":var E=l.vals.r;var p=registerGet(E,t);cycle(v,p,t,a,n+1,i);break;case"Blt":var R=l.vals.displacement;if(e<0)cycle(v+R,e,t,a,n+1,i);else cycle(v,e,t,a,n+1,i);break;case"Beq":var R=l.vals.displacement;if(e===0)cycle(v+R,e,t,a,n+1,i);else cycle(v,e,t,a,n+1,i);break;case"Bgt":var R=l.vals.displacement;if(e>0)cycle(v+R,e,t,a,n+1,i);else cycle(v,e,t,a,n+1,reclim);break;case"Jmp":var R=l.vals.displacement;cycle(v+R,e,t,a,n+1,i);break;case"Hlt":console.log("Halt");printState(r,e,t);break;default:printError("Unknown instruction "+l)}}function svm(r,e,t){var a=0;var n={r0:0,r1:0,r2:0,r3:0};cycle(e,a,n,r,0,t)}