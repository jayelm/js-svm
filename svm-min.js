var textInput=document.getElementById("text");var ramInput=document.getElementById("ram");var initialPcInput=document.getElementById("initialpc");var pcText=document.getElementById("PC");var pswText=document.getElementById("PSW");var r0Text=document.getElementById("R0");var r1Text=document.getElementById("R1");var r2Text=document.getElementById("R2");var r3Text=document.getElementById("R3");var errorText=document.getElementById("error");if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}function runSVM(){errorText.innerHTML="";var r=textInput.value.trim();var e=ramInput.value.trim();var t=initialPcInput.value.trim();if(r.length===0)printError("Text is empty");if(e.length===0)printError("RAM is empty");if(t.length===0)printError("Initial PC is empty");if(isNaN(t))printError("Initial PC "+t+" is not a number");t=parseInt(t);r=r.split("\n");var a=[];var n=[];if(e.charAt(0)==="["){if(e.charAt(e.length-1)!=="]")printError("Mismatched brackets: "+e);e=e.substring(1,e.length-1)}e=e.split(";");if(e.length===0)printError("RAM parse error");for(var s=0;s<e.length;s++){n.push(parseInt(e[s]))}for(var s=0;s<r.length;s++){a.push(parseInstruction(r[s]))}var i=new Image(n,a);console.log(i);svm(i,t)}function parseInstruction(r){r=r.trim();if(r.charAt(r.length-1)===";")r=r.substring(0,r.length-1);var e=r.substring(0,3);switch(e){case"Lod":case"Sto":case"Mov":case"Add":case"Sub":case"Cmp":var t=r.match(/{(.*)}/);if(t.length!==2)printError("Parse error for "+r);var a={};t=t[1].split(";");for(var n=0;n<t.length;n++){var s=t[n].split("=");var i=s[0].trim();var c=s[1].trim();if(!isNaN(c))c=parseInt(c);a[i]=c}return new Instruction(e,a);case"Blt":case"Beq":case"Bgt":case"Jmp":var v=r.substring(3);var l=v.trim();if(l.charAt(0)==="("){if(l.charAt(l.length-1)!==")")printError("Mismatched parentheses: "+r);l=l.substring(1,l.length-1)}if(isNaN(l))printError("Int expected for "+r);l=parseInt(l);var a={};a.displacement=l;return new Instruction(e,a);case"Cpz":var v=r.substring(3);var u=v.trim();if(!(u==="R0"||u==="R1"||u==="R2"||u==="R3"))printError("Register expected for "+r);var a={};a.r=u;return new Instruction(e,a);case"Hlt":return new Instruction(e,{});default:printError("Unknown instruction "+e)}}function printError(r){errorText.innerHTML+=r+"\n";throw r}function printState(r,e,t){pcText.value=r;pswText.value=e;r0Text.value=t.r0;r1Text.value=t.r1;r2Text.value=t.r2;r3Text.value=t.r3}function Instruction(r,e){this.type=r;this.vals=e}function Registers(r,e,t,a){this.r0=r;this.r1=e;this.r2=t;this.r3=a}function Image(r,e){this.data=r;this.text=e}function registerGet(r,e){switch(r){case"R0":return e.r0;case"R1":return e.r1;case"R2":return e.r2;case"R3":return e.r3;default:printError("Unknown register "+r)}}function registerPut(r,e,t){switch(e){case"R0":return new Registers(r,t.r1,t.r2,t.r3);case"R1":return new Registers(t.r0,r,t.r2,t.r3);case"R2":return new Registers(t.r0,t.r1,r,t.r3);case"R3":return new Registers(t.r0,t.r1,t.r2,r);default:printError("Unknown register "+e)}}function ramGet(r,e){return e[r]}function ramPut(r,e,t){var a=t.slice();a.splice(e,0,r);return a}function cycle(r,e,t,a){var n=a.text;var s=a.data;var i=ramGet(r,n);var c=r+1;printState(r,e,t);switch(i.type){case"Lod":var v=i.vals.rd;var l=i.vals.addr;var u=ramGet(l,s);var o=registerPut(u,v,t);cycle(c,e,o,a);break;case"Sto":var p=i.vals.rs;var l=i.vals.addr;var u=registerGet(p,t);var g=ramPut(u,l,s);cycle(c,e,t,new Image(a,g));break;case"Mov":var v=i.vals.rd;var p=i.vals.rs;var m=registerGet(p,t);var o=registerPut(m,v,t);cycle(c,e,o,a);break;case"Add":var v=i.vals.rd;var p=i.vals.rs;var d=i.vals.rt;var f=registerGet(p,t);var h=registerGet(d,t);var o=registerPut(f+h,v,t);cycle(c,e,o,a);break;case"Sub":var v=i.vals.rd;var p=i.vals.rs;var d=i.vals.rt;var f=registerGet(p,t);var h=registerGet(d,t);var o=registerPut(f-h,v,t);cycle(c,e,o,a);break;case"Cmp":var p=i.vals.rs;var d=i.vals.rt;var f=registerGet(p,t);var h=registerGet(d,t);var u=f-h;cycle(c,u,t,a);break;case"Cpz":var y=i.vals.r;var u=registerGet(y,t);cycle(c,u,t,a);break;case"Blt":var I=i.vals.displacement;if(e<0)cycle(c+I,e,t,a);else cycle(c,e,t,a);break;case"Beq":var I=i.vals.displacement;if(e===0)cycle(c+I,e,t,a);else cycle(c,e,t,a);break;case"Bgt":var I=i.vals.displacement;if(e>0)cycle(c+I,e,t,a);else cycle(c,e,t,a);break;case"Jmp":var I=i.vals.displacement;cycle(c+I,e,t,a);break;case"Hlt":console.log("Halt");printState(r,e,t);break;default:printError("Unknown instruction "+i)}}function svm(r,e){var t=0;var a={r0:0,r1:0,r2:0,r3:0};cycle(e,t,a,r)}