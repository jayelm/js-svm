var textInput=document.getElementById("text");var ramInput=document.getElementById("ram");var initialPcInput=document.getElementById("initialpc");var recLimInput=document.getElementById("recursionlimit");var pcText=document.getElementById("PC");var pswText=document.getElementById("PSW");var r0Text=document.getElementById("R0");var r1Text=document.getElementById("R1");var r2Text=document.getElementById("R2");var r3Text=document.getElementById("R3");var errorText=document.getElementById("error");if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}function rsv(){errorText.innerHTML="";var r=textInput.value.trim();var e=ramInput.value.trim();var a=initialPcInput.value.trim();var t=recLimInput.value.trim();if(r.length===0)pE("Text is empty");if(e.length===0)pE("RAM is empty");if(a.length===0)pE("Initial PC is empty");if(t.length===0)pE("recLim is empty");if(isNaN(a))pE("Initial PC "+a+" is not a number");if(isNaN(t))pE("Recursion limit "+t+" is not a number");a=parseInt(a);t=parseInt(t);r=r.replace(/\(\*.*\*\)/g,"");r=r.split("\n");var n=[];var s=[];if(e.charAt(0)==="["){if(e.charAt(e.length-1)!=="]")pE("Mismatched brackets: "+e);e=e.substring(1,e.length-1)}e=e.split(";");if(e.length===0)pE("RAM parse error");for(var v=0;v<e.length;v++){s.push(parseInt(e[v]))}for(var v=0;v<r.length;v++){n.push(pI(r[v]))}var i=new Img(s,n);console.log(i);sv(i,a,t)}function pI(r){r=r.trim();if(r.charAt(r.length-1)===";")r=r.substring(0,r.length-1);var e=r.substring(0,3);switch(e){case"Lod":case"Sto":case"Mov":case"Add":case"Sub":case"Mul":case"Div":case"Cmp":var a=r.match(/{(.*)}/);if(a.length!==2)pE("Parse error for "+r);var t={};a=a[1].split(";");for(var n=0;n<a.length;n++){var s=a[n].split("=");var v=s[0].trim();var i=s[1].trim();if(!isNaN(i))i=parseInt(i);t[v]=i}return new Inst(e,t);case"Blt":case"Beq":case"Bgt":case"Jmp":var c=r.substring(3);var l=c.trim();if(l.charAt(0)==="("){if(l.charAt(l.length-1)!==")")pE("Mismatched parentheses: "+r);l=l.substring(1,l.length-1)}if(isNaN(l))pE("Int expected for "+r);l=parseInt(l);var t={};t.displacement=l;return new Inst(e,t);case"Cpz":var c=r.substring(3);var u=c.trim();if(!(u==="R0"||u==="R1"||u==="R2"||u==="R3"))pE("Register expected for "+r);var t={};t.r=u;return new Inst(e,t);case"Hlt":return new Inst(e,{});default:pE("Unknown instruction "+e)}}function pE(r){errorText.innerHTML+=r+"\n";throw r}function pS(r,e,a){pcText.value=r;pswText.value=e;r0Text.value=a.r0;r1Text.value=a.r1;r2Text.value=a.r2;r3Text.value=a.r3}function Inst(r,e){this.type=r;this.vals=e}function Rgs(r,e,a,t){this.r0=r;this.r1=e;this.r2=a;this.r3=t}function Img(r,e){this.data=r;this.text=e}function reG(r,e){switch(r){case"R0":return e.r0;case"R1":return e.r1;case"R2":return e.r2;case"R3":return e.r3;default:pE("Unknown register "+r)}}function reP(r,e,a){switch(e){case"R0":return new Rgs(r,a.r1,a.r2,a.r3);case"R1":return new Rgs(a.r0,r,a.r2,a.r3);case"R2":return new Rgs(a.r0,a.r1,r,a.r3);case"R3":return new Rgs(a.r0,a.r1,a.r2,r);default:pE("Unknown register "+e)}}function raG(r,e){return e[r]}function raP(r,e,a){var t=a.slice();t.splice(e,0,r);return t}function cy(r,e,a,t,n,s){if(n>s)pE("Recursion limit "+s+" exceeded");var v=t.text;var i=t.data;var c=raG(r,v);var l=r+1;pS(r,e,a);switch(c.type){case"Lod":var u=c.vals.rd;var p=c.vals.addr;var o=raG(p,i);var m=reP(o,u,a);cy(l,e,m,t,n+1,s);break;case"Sto":var d=c.vals.rs;var p=c.vals.addr;var o=reG(d,a);var g=raP(o,p,i);cy(l,e,a,new Img(g,v),n+1,s);break;case"Mov":var u=c.vals.rd;var d=c.vals.rs;var f=reG(d,a);var m=reP(f,u,a);cy(l,e,m,t,n+1,s);break;case"Add":var u=c.vals.rd;var d=c.vals.rs;var h=c.vals.rt;var y=reG(d,a);var I=reG(h,a);var m=reP(y+I,u,a);cy(l,e,m,t,n+1,s);break;case"Sub":var u=c.vals.rd;var d=c.vals.rs;var h=c.vals.rt;var y=reG(d,a);var I=reG(h,a);var m=reP(y-I,u,a);cy(l,e,m,t,n+1,s);break;case"Mul":var u=c.vals.rd;var d=c.vals.rs;var h=c.vals.rt;var y=reG(d,a);var I=reG(h,a);var m=reP(y*I,u,a);cy(l,e,m,t,n+1,s);break;case"Div":var u=c.vals.rd;var d=c.vals.rs;var h=c.vals.rt;var y=reG(d,a);var I=reG(h,a);var m=reP(Math.floor(y/I),u,a);cy(l,e,m,t,n+1,s);break;case"Cmp":var d=c.vals.rs;var h=c.vals.rt;var y=reG(d,a);var I=reG(h,a);var o=y-I;cy(l,o,a,t,n+1,s);break;case"Cpz":var E=c.vals.r;var o=reG(E,a);cy(l,o,a,t,n+1,s);break;case"Blt":var R=c.vals.displacement;if(e<0)cy(l+R,e,a,t,n+1,s);else cy(l,e,a,t,n+1,s);break;case"Beq":var R=c.vals.displacement;if(e===0)cy(l+R,e,a,t,n+1,s);else cy(l,e,a,t,n+1,s);break;case"Bgt":var R=c.vals.displacement;if(e>0)cy(l+R,e,a,t,n+1,s);else cy(l,e,a,t,n+1,reclim);break;case"Jmp":var R=c.vals.displacement;cy(l+R,e,a,t,n+1,s);break;case"Hlt":console.log("Halt");pS(r,e,a);break;default:pE("Unknown instruction "+c)}}function sv(r,e,a){var t=0;var n={r0:0,r1:0,r2:0,r3:0};cy(e,t,n,r,0,a)}
